<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nl.pm.server.registry.dao.SystemProjectDao">
    <insert id="batchSaveSystemStage" parameterType="list">
        set SQL_SAFE_UPDATES = 0;
        delete from `system_stage`;
        set SQL_SAFE_UPDATES = 1;

        INSERT INTO `system_stage` (crm_stage_id,crm_stage_name) VALUES
        <foreach collection="collect" item="item" separator=",">
            (#{item.crmStageId},#{item.crmStageName})
        </foreach>
    </insert>
    <update id="updateStage">
        UPDATE `system_stage` SET crm_stage_name = #{name} WHERE crm_stage_id = #{id}
    </update>
    <select id="distinctGetAllStage" resultType="com.nl.pm.server.registry.entity.SystemStageEntity">
        SELECT * FROM `system_stage`
    </select>
    <insert id="batchSave" >
        INSERT INTO `system_project` (name,enable,crm_project_id,crm_stage_id,crm_customer_name_short)
        VALUES
        <foreach collection="list" item="entity" separator=",">
            (#{entity.name},0,#{entity.crmProjectId},#{entity.crmStageId},#{entity.crmCustomerNameShort})
        </foreach>
    </insert>
    <update id="updateProjectTemplate">
        UPDATE `system_project` SET
        area_id = #{areaId}
        <if test="areaId != null">
            ,enable = true
        </if>
        <if test="areaId == null">
            ,enable = false
            ,force_desc_flag = false
        </if>
        WHERE id = #{id}
    </update>
    <select id="queryProjectTemplateCountByName" resultType="integer">
        SELECT COUNT(pt.id)
        FROM
            `system_project` pt
        WHERE
            pt.name = #{name}
    </select>

    <select id="querySystemProjectPaging" resultType="com.nl.pm.server.registry.entity.SystemProjectEntity">
        SELECT
            sp.`id`,
            sp.`name`,
            sp.`enable`,
            sp.`create_time`,
            sp.`update_time`,
            sp.crm_project_id,
            sp.crm_stage_id,
            ss.crm_stage_name,
            sp.`area_id`,
            sp.`goal_hours`,
            sp.`def2`,
            sp.`def3`,
            sp.`def4`,
            sp.`def5`,
            a.name AS areaName,
            sp.`force_desc_flag` as forceDescFlag
        FROM
            `system_project` sp
        LEFT JOIN `area` a ON a.id = sp.area_id
        LEFT JOIN `system_stage` ss ON ss.crm_stage_id = sp.crm_stage_id
        <where>
            <if test="entityParam.systemProjectName != null and entityParam.systemProjectName != ''">
                sp.name like concat ('%', #{entityParam.systemProjectName}, '%')
            </if>
            <if test="entityParam.crmProjectId != null and entityParam.crmProjectId != ''">
                AND sp.crm_project_id like concat ('%', #{entityParam.crmProjectId}, '%')
            </if>
            <if test="entityParam.crmStageId != null and entityParam.crmStageId != ''">
                AND sp.crm_stage_id = #{entityParam.crmStageId}
            </if>
            <if test="entityParam.areaId != null">
                AND sp.area_id = #{entityParam.areaId}
            </if>
            <if test="entityParam.enable != null">
                AND sp.enable = #{entityParam.enable}
            </if>
        </where>
        order by name asc
    </select>

    <update id="editProjectTemplateByCrmId" parameterType="com.nl.pm.server.registry.entity.SystemProjectEntity" >
        set SQL_SAFE_UPDATES = 0;
        UPDATE `system_project`
        SET
            name = #{entity.name}
        <if test="entity.crmStageId != null">
            ,crm_stage_id = #{entity.crmStageId}
        </if>
        <if test="entity.crmCustomerNameShort != null">
            ,crm_customer_name_short = #{entity.crmCustomerNameShort}
        </if>
        WHERE
        crm_project_id = #{entity.crmProjectId};
        set SQL_SAFE_UPDATES = 1;
    </update>
    <update id="changeForceDescFlag">
        update system_project set force_desc_flag =#{flag}
        where id =#{id}
    </update>
    <update id="updateSystemProjectNameById">
        update system_project set name =#{name}
        where id =#{id};
        update project set name =#{name}
        where system_project_id = #{id}

    </update>
    <update id="editGoalHours">
        update `system_project` set `goal_hours` = #{goalHours}
        where id = #{id}


    </update>
    <update id="editProjectTemplateByName">
        set SQL_SAFE_UPDATES = 0;
        UPDATE `system_project`
        SET
        crm_project_id = #{entity.crmProjectId}
        <if test="entity.crmStageId != null">
            ,crm_stage_id = #{entity.crmStageId}
        </if>
        <if test="entity.crmCustomerNameShort != null">
            ,crm_customer_name_short = #{entity.crmCustomerNameShort}
        </if>
        WHERE
        name = #{entity.name};

        set SQL_SAFE_UPDATES = 1;

    </update>
    <select id="queryProjectTemplateByCrmId" parameterType="com.nl.pm.server.registry.entity.SystemProjectEntity" resultType="com.nl.pm.server.registry.entity.SystemProjectEntity">
        SELECT 	`id`,
        `name`,
        `enable`,
        `create_time`,
        `update_time`,
        `area_id`,
        `crm_project_id`,
        `crm_stage_id`,
        `def2`,
        `def3`,
        `def4`,
        `def5`
        FROM
        `system_project`
        WHERE
        crm_project_id = #{entity.crmProjectId}
    </select>
    <select id="getSystemProjectById" resultType="com.nl.pm.server.registry.entity.SystemProjectEntity">
        select * from system_project where id =#{id}
    </select>
    <select id="getSystemProjectByName" resultType="com.nl.pm.server.registry.entity.SystemProjectEntity">
        select * from system_project where name =#{name}
    </select>

</mapper>