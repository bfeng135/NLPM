<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nl.pm.server.registry.dao.AreaDao">
    <select id="getAllAreaByIds" resultType="com.nl.pm.server.registry.entity.AreaEntity">
        SELECT name FROM `area`
        <if test="areaId != null and areaId.length > 0">
            WHERE id IN
            <foreach collection="areaId" separator="," item="id" open="(" close=")">
                #{id}
            </foreach>
        </if>
    </select>
    <select id="queryCountManager" resultType="integer">
        SELECT 	COUNT(1)
        FROM
        `area`
        WHERE manager_id = #{userId}
    </select>
    <update id="updateAreaByAreaId">
        UPDATE `area` SET `manager_id` = null WHERE id = #{areaId}
    </update>
    <select id="queryAreaByUserId" resultType="com.nl.pm.server.registry.entity.AreaEntity">
        SELECT `id`, `name`, `desc`, `manager_id`, `create_time`, `update_time` FROM `area` WHERE manager_id = #{userId} AND id = #{areaId}
    </select>

    <!--  新增区域  -->
    <insert id="addArea" useGeneratedKeys="true" keyProperty="areaEntity.id" parameterType="com.nl.pm.server.registry.entity.AreaEntity">
        insert into area(`name`,`desc`,`manager_id`)
        values (#{areaEntity.name},#{areaEntity.desc},#{areaEntity.managerId})
    </insert>

    <!--  编辑区域  -->
    <update id="updateArea" parameterType="com.nl.pm.server.registry.entity.AreaEntity">
        UPDATE area
        SET
            area.name = #{areaEntity.name},
            area.desc = #{areaEntity.desc},
            area.manager_id = #{areaEntity.managerId}
        WHERE `id` = #{areaEntity.id};
    </update>

    <!--  删除区域  -->
    <delete id="deleteArea">
        delete from area where id = #{areaId};
        delete from `project` where area_id = #{areaId}
    </delete>

    <!--  查询区域详情  -->
    <select id="getAreaById" resultType="com.nl.pm.server.registry.entity.AreaEntity">
        select a.`id`,
               a.`name`,
               a.`desc`,
               a.`manager_id`,
               u.`nickname` as nickname,
               a.`create_time`,
               a.`update_time`
        from `area` as a
        left join `user` as u on a.`manager_id` = u.`id`
        where a.`id` = #{areaId}
    </select>

    <!--  查询区域列表  -->
    <select id="getAreaList" resultType="com.nl.pm.server.registry.entity.AreaEntity">
        select area.id,
               area.name,
               area.status,
               area.desc,
               area.manager_id,
               area.create_time,
               area.update_time,
               user.username as managerName,
                user.nickname as nickname
        from area
        left join user on area.manager_id = user.id
        <where>
            <if test="param.globalName != null and param.globalName != ''">
                area.name like concat('%',#{param.globalName},'%')
            </if>
            <if test="param.statusFlag != null">
                and area.status = #{param.statusFlag}
            </if>
        </where>
        <if test="param.startIndex > -1 and param.pageSize > 0">
            LIMIT #{param.startIndex}, #{param.pageSize}
        </if>
    </select>

    <!--  查询区域总数  -->
    <select id="getAreaTotalByParams" resultType="java.lang.Long">
        select count(area.id)
        from area
        <where>
            <if test="param.globalName != null and param.globalName != ''">
                area.name like concat('%',#{param.globalName},'%')
            </if>
            <if test="param.statusFlag != null">
                and area.status = #{param.statusFlag}
            </if>
        </where>
    </select>


    <select id="checkAreaDayReport" parameterType="Integer" resultType="Integer">
        SELECT SUM(t.id) FROM (
        SELECT COUNT(dr.id) AS id FROM `day_report` dr WHERE dr.user_id IN
        (SELECT u2.id FROM `user` u2 WHERE id IN (SELECT aua.user_id FROM `area_user_ass` aua WHERE aua.area_id = #{areaId}
        UNION ALL
        SELECT u.id FROM `user` u WHERE u.area_id = #{areaId}))
        UNION ALL
        SELECT COUNT(dr.id) AS id FROM `day_report` dr WHERE dr.user_id IN (SELECT a.manager_id FROM `area` a WHERE id = #{areaId})
        ) t
    </select>

    <select id="checkAreaOtherProject" parameterType="map" resultType="Integer">
        select count(p.`id`)
        from `project` as p
        where
            p.`area_id` = #{areaId}
        and
            p.`name` not in
            <foreach collection="nameList" item="name" open="(" close=")" separator="," index="">
                #{name}
            </foreach>
    </select>

    <select id="checkAreaOtherUser" parameterType="Integer" resultType="Integer">
        select count(u.`id`)
        from `user` as u
        where u.`area_id` = #{areaId}
        and u.`id` != (select a.manager_id from `area` as a where a.`id` = #{areaId})
    </select>

    <select id="checkAreaName" parameterType="String" resultType="Integer">
        select count(`id`)
        from `area`
        where `name` = #{name}

    </select>

    <update id="assignUserToArea" parameterType="map" >

        delete from `area_user_ass` where `area_id` =#{areaId};
        <if test="userIdList != null and userIdList.size()>0">
        insert into `area_user_ass`
            (`area_id`,`user_id`)
            values
            <foreach collection="userIdList" item="userId"  separator=",">
                ( #{areaId} , #{userId} )
            </foreach>
        </if>
    </update>

    <update id="updateAreaStatus">
        update area set status = #{status} where id = #{areaId}

    </update>

    <select id="searchOtherAreaAssUser" parameterType="Integer" resultType="com.nl.pm.server.registry.entity.UserEntity">
        select
            u.`id` as id,
            u.`nickname` as nickname,
            u.`area_id` as areaId,
            a.`name` as areaName
        from `area_user_ass` as aua
        inner join `user` as u on u.`id` = aua.`user_id`
        left join `area` as a on a.id = u.`area_id`
        where aua.`area_id` = #{areaId}
    </select>

    <select id="projectNameASSAreaList" resultType="com.nl.pm.server.registry.entity.AreaEntity">
        select
            a.id,
            a.name,
            a.desc,
            a.manager_id,
            a.create_time,
            a.update_time
        from `area` as a
        left join `project` as p on a.id = p.`area_id`
        where p.name = #{projectName}

    </select>
</mapper>